{% extends 'base.html.twig' %}

{% block title %}
	{{lesson.title}}
{% endblock %}

{% block body %}

	{#  Condition qui se répète souvent / Evite de recalculer #}
	{% set user = app.user %}

	{% if is_granted('ROLE_EDITOR') %}
		{% set route = "editor" %}
		{% set student = false %}
	{% else %}
		{% set route = "profile"%}
		{% set student = true %}
	{% endif %}

	{% if user in lesson.users%}
		{% set own = true %}
	{% else %}
		{% set own = false %}
	{% endif %}

	{% if not student %}
		{% set succes = lesson.success_rate %}
		{% if succes == '/' %}
			{% set stat = "secondary" %}
		{% elseif succes == 100  %}
			{% set stat = "success"%}
		{% elseif succes >= 50  %}
			{% set stat = "warning" %}
		{% else %}
			{% set stat = "danger" %}
		{% endif %}
	{% endif %}

	<div>
		<h2>
			{{ lesson.title }}
			{% if not student %}
				<span class="badge badge-pill badge-{{stat}}" data-toggle="tooltip" title="Pourcentage de réussite du lessons">{{succes}}</span>
			{% endif %}
		</h2>
		<div class="metadata">
			Ecrit le
			{{lesson.createdAt | date('d/m/Y')}}
			à
			{{lesson.createdAt | date('H:i')}}
			par
			{{lesson.createdBy}}
		</div>
		<div>
			{{lesson.content | raw}}
		</div>

	</div><hr>

	<table class="table table-hover">
		<h3>Liste des exercices</h3>

		{% if not lesson.exercises is empty %}
			{% if not student and own %}
				<thead>
					<tr>
						<th>Titre</th>
						<th>Taux de reussite</th>
						<th>Nombre de tentative</th>
					</tr>
				</thead>
			{% endif %}
		{% endif %}

		<tbody>
			{% for exercise in lesson.exercises  %}

				{% if not student and own %}
					{# Côté enseignant #}
					{% set succes_rate = exercise.success_rate %}
					{% if succes_rate == '/' %}
						{% set status = "table-primary" %}
					{% elseif succes_rate == 100  %}
						{% set status = "table-success"%}
					{% elseif succes_rate >= 50  %}
						{% set status = "table-warning" %}
					{% else %}
						{% set status = "table-danger" %}
					{% endif %}
				{% else %}
					{# Côté Etudiant #}
					{% if app.user.getNotation(exercise) == null %}
						{% set status = "table-secondary" %}
					{% elseif app.user.getNotation(exercise).getNote == 100 %}
						{% set status = "table-success"%}
					{% elseif app.user.getNotation(exercise).getNote >= 50 %}
						{% set status = "table-warning" %}
					{% else %}
						{% set status = "table-danger" %}
					{% endif %}
				{% endif %}

				<tr class="{{status}}">

					<td>
						{% if own %}
							{# Il faut être le créateur de l'exercice ou être inscrit pour accéder à l'exercice #}
							<a href="{{path(route ~'_show_exercises', {'id1' : lesson.id, 'id2' : exercise.id})}}">
								<div style="height:100%;width:100%">
									{{exercise.title}}
								</div>
							</a>
						{% else %}
							{{exercise.title}}
						{% endif %}
					</td>

					{% if not student and own %}
						<td>{{exercise.success_rate}}</td>
						<td>{{exercise.attempts}}</td>
					{% endif %}
				</tr>


			{% endfor %}
		</tbody>
	</table>

	{% if not student and own %}
		<nav class="navbar navbar-expand-lg ">
			<div class="collapse navbar-collapse" id="navbarColor03">

				<ul class="navbar-nav mr-auto">
					<li>
						<a href="{{path('editor_edit_cours', {'id' : lesson.id})}}" class="btn btn-primary">Modifier le cours</a>
					</li>
				</ul>

				<ul class="navbar-nav ml-auto">
					<li>
						<a href="{{path('editor_create_exercise', {'id1' : lesson.id})}}" class="btn btn-success">Ajouter un exercice</a>
					</li>
				</ul>

			</div>
		</nav>
	{% endif %}

	<nav class="navbar navbar-expand-lg ">
		<div class="collapse navbar-collapse" id="navbarColor03">

			<ul class="navbar-nav mr-auto">
				<li class="nav-item">
					<a href="{{path('profile_my_lessons')}}" class="btn btn-primary">Retour</a>
				</li>
			</ul>

			<ul class="navbar-nav ml-auto">
				{% if  route != "editor"%}
					{% if own %}
						<li class="nav-item">
							<a class="btn btn-danger" href="{{path('profile_unregisterLesson', {'id' : lesson.id} )}}">Se désinscrire</a>
						</li>
					{% else %}
						<li class="nav-item">
							<a class="btn btn-success" href="{{path('profile_registerLesson', {'id' : lesson.id} )}}">S'inscrire</a>
						</li>
					{% endif %}
				{% endif %}
			</ul>

		</div>
	</nav>

{% endblock %}
